# CCTV Seat Detection System - ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

## ğŸ“Š ì „ì²´ ì‹œìŠ¤í…œ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            CLOUD LAYER (ë¬´ë£Œ)                                 â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                          Supabase Cloud                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ PostgreSQL â”‚  â”‚  Real-time  â”‚  â”‚   Storage    â”‚  â”‚  REST API   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Database  â”‚  â”‚ Subscriptionsâ”‚  â”‚  (Images)    â”‚  â”‚ (Auto-gen)  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚            â”‚  â”‚              â”‚  â”‚              â”‚  â”‚             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ stores   â”‚  â”‚ â€¢ WebSocket  â”‚  â”‚ â€¢ Snapshots  â”‚  â”‚ â€¢ SELECT    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ seats    â”‚  â”‚ â€¢ Pub/Sub    â”‚  â”‚ â€¢ Annotated  â”‚  â”‚ â€¢ INSERT    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ status   â”‚  â”‚ â€¢ Live feed  â”‚  â”‚   Images     â”‚  â”‚ â€¢ UPDATE    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ events   â”‚  â”‚              â”‚  â”‚              â”‚  â”‚ â€¢ DELETE    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â–²                                         â”‚
â”‚                                     â”‚ HTTPS (REST + WebSocket)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         APPLICATION LAYER (ì„œë²„)                              â”‚
â”‚                                     â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                          FastAPI Servers                                 â”‚ â”‚
â”‚  â”‚                                                                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  ROI Config API         â”‚      â”‚  Seats Management API           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  (Port 8000)            â”‚      â”‚  (Port 8001)                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                         â”‚      â”‚                                 â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ GET /api/channels    â”‚      â”‚  â€¢ GET /api/stores              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ GET /snapshot        â”‚      â”‚  â€¢ GET /api/stores/{id}/status  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ POST /config         â”‚      â”‚  â€¢ GET /api/stores/{id}/events  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ POST /auto-detect    â”‚      â”‚  â€¢ PATCH /api/stores/{id}/seats â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ POST /detect         â”‚      â”‚  â€¢ POST /api/events             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                         â”‚      â”‚  â€¢ GET /api/stores/{id}/stats   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  ğŸ“„ Static Files:       â”‚      â”‚                                 â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ index.html (ROI UI)  â”‚      â”‚  ğŸ“„ Static Files:               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                         â”‚      â”‚  â€¢ dashboard.html               â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â–²                                         â”‚
â”‚                                     â”‚ HTTP/WebSocket                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         Web Browsers                                     â”‚ â”‚
â”‚  â”‚                                   â”‚                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚   ROI Config UI   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  Monitoring Dashboard  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                   â”‚                      â”‚                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ RTSP Snapshot  â”‚                      â”‚  â€¢ Store Selector      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Polygon Draw   â”‚                      â”‚  â€¢ Seat Grid           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Auto-detect    â”‚                      â”‚  â€¢ Real-time Status    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Save/Load      â”‚                      â”‚  â€¢ Event Timeline      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â€¢ Statistics          â”‚ â”‚ â”‚
â”‚  â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Detection Workers (ë©€í‹°í”„ë¡œì„¸ìŠ¤)                     â”‚  â”‚
â”‚  â”‚                                                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  Worker 1    â”‚  â”‚  Worker 2    â”‚  â”‚  Worker 3    â”‚  â”‚  Worker 4  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ Channel 1-4  â”‚  â”‚ Channel 5-8  â”‚  â”‚ Channel 9-12 â”‚  â”‚ Ch 13-16   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ YOLO     â”‚ â”‚  â”‚ â”‚ YOLO     â”‚ â”‚  â”‚ â”‚ YOLO     â”‚ â”‚  â”‚ â”‚ YOLO   â”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ Detector â”‚ â”‚  â”‚ â”‚ Detector â”‚ â”‚  â”‚ â”‚ Detector â”‚ â”‚  â”‚ â”‚Detectorâ”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚      â†“       â”‚  â”‚      â†“       â”‚  â”‚      â†“       â”‚  â”‚     â†“      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚   ROI    â”‚ â”‚  â”‚ â”‚   ROI    â”‚ â”‚  â”‚ â”‚   ROI    â”‚ â”‚  â”‚ â”‚  ROI   â”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ Matcher  â”‚ â”‚  â”‚ â”‚ Matcher  â”‚ â”‚  â”‚ â”‚ Matcher  â”‚ â”‚  â”‚ â”‚Matcher â”‚ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  â”‚
â”‚  â”‚  â”‚      â†“       â”‚  â”‚      â†“       â”‚  â”‚      â†“       â”‚  â”‚     â†“      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Supabase   â”‚  â”‚  Supabase   â”‚  â”‚  Supabase   â”‚  â”‚  Supabase  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚   Update    â”‚  â”‚   Update    â”‚  â”‚   Update    â”‚  â”‚   Update   â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚          â†“                â†“                â†“                  â†“         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚                â”‚                â”‚                  â”‚            â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                     â”‚ RTSP (TCP)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          HARDWARE LAYER                                       â”‚
â”‚                                     â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                              NVR System                                   â”‚ â”‚
â”‚  â”‚                                                                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚ Ch1 â”‚ â”‚ Ch2 â”‚ â”‚ Ch3 â”‚ â”‚ Ch4 â”‚ â”‚ Ch5 â”‚ â”‚ Ch6 â”‚ â”‚ Ch7 â”‚ â”‚ Ch8 â”‚ ... â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â”‚                                                                           â”‚ â”‚
â”‚  â”‚  RTSP: rtsp://admin:pwd@host:8554/live_01 ~ live_16                     â”‚ â”‚
â”‚  â”‚  Protocol: TCP (fallback to UDP)                                        â”‚ â”‚
â”‚  â”‚  Resolution: 1920x1080                                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â–²                                         â”‚
â”‚                                     â”‚ Video Feed                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                          Physical Cameras (16ëŒ€)                          â”‚ â”‚
â”‚  â”‚                                                                           â”‚ â”‚
â”‚  â”‚  Camera 1-16: ì•¤ë”© ìŠ¤í„°ë””ì¹´í˜ ì¢Œì„ ì˜ì—­ ì´¬ì˜                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EXTERNAL INTEGRATION                                    â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           GoSca API                                    â”‚  â”‚
â”‚  â”‚                  https://gosca.co.kr/gosca/seatlist                   â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  Response:                                                             â”‚  â”‚
â”‚  â”‚  {                                                                     â”‚  â”‚
â”‚  â”‚    "components": [                                                     â”‚  â”‚
â”‚  â”‚      {                                                                 â”‚  â”‚
â”‚  â”‚        "chairtbl_id": "A-01",                                          â”‚  â”‚
â”‚  â”‚        "celltype": "chair",                                            â”‚  â”‚
â”‚  â”‚        "startRow": 0, "startCol": 0,                                   â”‚  â”‚
â”‚  â”‚        "status": "empty"/"occupied",                                   â”‚  â”‚
â”‚  â”‚        "walls": {...}                                                  â”‚  â”‚
â”‚  â”‚      }                                                                 â”‚  â”‚
â”‚  â”‚    ]                                                                   â”‚  â”‚
â”‚  â”‚  }                                                                     â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  â€¢ ì¢Œì„ ë§ˆìŠ¤í„° ë°ì´í„°                                                   â”‚  â”‚
â”‚  â”‚  â€¢ ê·¸ë¦¬ë“œ ìœ„ì¹˜ (11x11)                                                  â”‚  â”‚
â”‚  â”‚  â€¢ 55ê°œ ì¢Œì„ ì •ë³´                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ ë°ì´í„° íë¦„

### 1ï¸âƒ£ ì´ˆê¸° ì„¤ì • ë‹¨ê³„

```
GoSca API â†’ import_gosca_seats.py â†’ Supabase
                                        â†“
                          stores í…Œì´ë¸” ìƒì„± (ì§€ì  ì •ë³´)
                          seats í…Œì´ë¸” ìƒì„± (55ê°œ ì¢Œì„)
                          seat_status ì´ˆê¸°í™” (ëª¨ë‘ empty)
```

### 2ï¸âƒ£ ROI ì„¤ì • ë‹¨ê³„

```
ì‚¬ìš©ì â†’ ROI Config UI (Port 8000) â†’ ROI Config API
            â†“                              â†“
    1. Load Snapshot (RTSP)         RTSP Client
    2. Draw Polygon                      â†“
    3. Save Config                  Supabase.seats
                                    (roi_polygon ì—…ë°ì´íŠ¸)
```

### 3ï¸âƒ£ ì‹¤ì‹œê°„ ê°ì§€ ë‹¨ê³„ (ì£¼ìš” ë¡œì§)

```
NVR â†’ RTSP Stream (1920x1080 @ 3fps)
         â†“
    Worker Process (x4)
         â†“
    [Every 3 seconds]
         â†“
    1. Capture Frame (cv2.VideoCapture)
         â†“
    2. YOLO Detection (yolo11n.pt)
         â†“
    3. ROI Matching (polygon point-in)
         â†“
    4. Status Calculation
         â†“
    5. Event Detection (status changed?)
         â†“
    6. Supabase Update
         â”œâ”€ seat_status.upsert()
         â””â”€ detection_events.insert()
         â†“
    Real-time Broadcast (WebSocket)
         â†“
    Dashboard Auto-refresh
```

### 4ï¸âƒ£ ëª¨ë‹ˆí„°ë§ ë‹¨ê³„

```
Dashboard (Port 8001) â†’ Seats API â†’ Supabase
    â†“                       â†“            â†“
GET /stores           list_stores()  SELECT * FROM v_store_occupancy_summary
GET /status           get_all_status() SELECT * FROM seat_status
GET /events           get_events()   SELECT * FROM detection_events ORDER BY created_at DESC
    â†“
[Every 10 seconds Auto-refresh]
```

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### í•µì‹¬ í…Œì´ë¸”

#### 1. **stores** (ì§€ì  ì •ë³´)
```sql
stores (
  store_id        VARCHAR(50) PK    -- 'oryudong', 'gangnam'
  gosca_store_id  VARCHAR(100)      -- 'Anding-Oryudongyeok-sca'
  store_name      VARCHAR(100)      -- 'ì•¤ë”© ì˜¤ë¥˜ë™ì—­ì '
  rtsp_host       VARCHAR(100)      -- '218.50.241.157'
  rtsp_port       INT               -- 8554
  total_channels  INT               -- 16
  is_active       BOOLEAN           -- true
)
```

#### 2. **seats** (ì¢Œì„ ì •ë³´ + ROI ë§¤í•‘)
```sql
seats (
  store_id      VARCHAR(50) PK
  seat_id       VARCHAR(20) PK    -- 'A-01', 'B-05'
  chairtbl_id   VARCHAR(50)       -- GoSca ID
  grid_row      INT               -- 0-10 (11x11 grid)
  grid_col      INT               -- 0-10
  channel_id    INT               -- 1-16 (CCTV ì±„ë„)
  roi_polygon   JSONB             -- [[x1,y1], [x2,y2], ...]
  seat_type     VARCHAR(20)       -- 'daily', 'fixed'
  seat_label    VARCHAR(50)       -- 'A-01ë²ˆ ì¢Œì„'
  is_active     BOOLEAN
)
```

#### 3. **seat_status** (ì‹¤ì‹œê°„ ì¢Œì„ ìƒíƒœ) â­
```sql
seat_status (
  store_id                VARCHAR(50) PK
  seat_id                 VARCHAR(20) PK
  status                  VARCHAR(20)      -- 'empty', 'occupied', 'abandoned'
  person_detected         BOOLEAN
  object_detected         BOOLEAN
  detection_confidence    FLOAT            -- 0.0 - 1.0
  last_person_seen        TIMESTAMP
  last_empty_time         TIMESTAMP
  vacant_duration_seconds INT              -- ë¹ˆ ì¢Œì„ ì§€ì† ì‹œê°„
  updated_at              TIMESTAMP        -- ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸
)
```

#### 4. **detection_events** (ì´ë²¤íŠ¸ ë¡œê·¸)
```sql
detection_events (
  id              BIGSERIAL PK
  store_id        VARCHAR(50)
  seat_id         VARCHAR(20)
  channel_id      INT
  event_type      VARCHAR(50)      -- 'person_enter', 'person_leave', 'abandoned_detected'
  previous_status VARCHAR(20)
  new_status      VARCHAR(20)
  person_detected BOOLEAN
  object_detected BOOLEAN
  confidence      FLOAT
  bbox_x1, bbox_y1, bbox_x2, bbox_y2  INT  -- Bounding box
  snapshot_path   TEXT
  metadata        JSONB            -- {detections_count: 1, iou: 0.85}
  created_at      TIMESTAMP
)
```

## ğŸ”Œ API ì—”ë“œí¬ì¸íŠ¸

### ROI Config API (Port 8000)
```
GET  /                              ì›¹ UI ì œê³µ
GET  /api/channels                  ì±„ë„ ëª©ë¡ (1-16)
GET  /api/channels/{id}/snapshot    RTSP ìŠ¤ëƒ…ìƒ· ìº¡ì²˜
GET  /api/channels/{id}/config      ROI ì„¤ì • ë¡œë“œ
POST /api/channels/{id}/config      ROI ì„¤ì • ì €ì¥
POST /api/channels/{id}/auto-detect Auto-detect seats
POST /api/channels/{id}/detect      Detection ì‹¤í–‰ (í…ŒìŠ¤íŠ¸)
```

### Seats Management API (Port 8001)
```
GET  /api/stores                           ì§€ì  ëª©ë¡
GET  /api/stores/{id}                      ì§€ì  ìƒì„¸
GET  /api/stores/{id}/summary              ì ìœ ìœ¨ ìš”ì•½
POST /api/stores/{id}/sync-gosca           GoSca ë™ê¸°í™”

GET  /api/stores/{id}/seats                ì¢Œì„ ëª©ë¡
GET  /api/stores/{id}/seats/{sid}          ì¢Œì„ ìƒì„¸
PATCH /api/stores/{id}/seats/{sid}/roi     ROI ì—…ë°ì´íŠ¸

GET  /api/stores/{id}/status               ì „ì²´ ì¢Œì„ ìƒíƒœ
GET  /api/stores/{id}/status/{sid}         íŠ¹ì • ì¢Œì„ ìƒíƒœ
PATCH /api/stores/{id}/status/{sid}        ìƒíƒœ ì—…ë°ì´íŠ¸ (Workerìš©)
GET  /api/stores/{id}/vacant               ë¹ˆ ì¢Œì„ ì¡°íšŒ
GET  /api/stores/{id}/abandoned            ë°©ì¹˜ë¬¼í’ˆ ì¡°íšŒ

POST /api/events                           ì´ë²¤íŠ¸ ë¡œê¹… (Workerìš©)
GET  /api/stores/{id}/events               ìµœê·¼ ì´ë²¤íŠ¸
GET  /api/stores/{id}/seats/{sid}/events   ì¢Œì„ë³„ ì´ë²¤íŠ¸

GET  /api/stores/{id}/stats                í†µê³„ (ì‹œê°„ë³„ ì ìœ ìœ¨)
GET  /health                               Health check
```

## ğŸƒ í”„ë¡œì„¸ìŠ¤ êµ¬ì¡°

### Detection Worker í”„ë¡œì„¸ìŠ¤

```python
MultiChannelWorker (Main Process)
    â†“
    â”œâ”€ ChannelWorker Process 1 (PID: 1001)
    â”‚   â”œâ”€ RTSP Client (Channel 1-4)
    â”‚   â”œâ”€ YOLO Detector (yolo11n.pt)
    â”‚   â”œâ”€ ROI Matcher (4 seats)
    â”‚   â””â”€ Supabase Client
    â”‚
    â”œâ”€ ChannelWorker Process 2 (PID: 1002)
    â”‚   â”œâ”€ RTSP Client (Channel 5-8)
    â”‚   â”œâ”€ YOLO Detector
    â”‚   â”œâ”€ ROI Matcher (4 seats)
    â”‚   â””â”€ Supabase Client
    â”‚
    â”œâ”€ ChannelWorker Process 3 (PID: 1003)
    â”‚   â””â”€ ...
    â”‚
    â””â”€ ChannelWorker Process 4 (PID: 1004)
        â””â”€ ...
```

**íŠ¹ì§•**:
- ê° í”„ë¡œì„¸ìŠ¤ ë…ë¦½ ì‹¤í–‰ (Crash ê²©ë¦¬)
- Shared stop_eventë¡œ graceful shutdown
- ê° í”„ë¡œì„¸ìŠ¤ê°€ ìì²´ DB ì—°ê²° ë³´ìœ 
- í”„ë¡œì„¸ìŠ¤ë‹¹ 4ì±„ë„ ì²˜ë¦¬ (ë³‘ë ¬ì„±)

## ğŸ” ë³´ì•ˆ

### í™˜ê²½ ë³€ìˆ˜ (.env)
```bash
# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_KEY=eyJ...                    # anon public (í´ë¼ì´ì–¸íŠ¸ìš©, RLS ë³´í˜¸)
SUPABASE_SERVICE_KEY=eyJ...            # service role (ì„œë²„ìš©, ì ˆëŒ€ ë…¸ì¶œ ê¸ˆì§€!)

# RTSP
RTSP_USERNAME=admin
RTSP_PASSWORD=****
RTSP_HOST=218.50.241.157
```

### Row Level Security (RLS)
- ê°œë°œ: ë¹„í™œì„±í™” (ëª¨ë“  í…Œì´ë¸”)
- í”„ë¡œë•ì…˜: í™œì„±í™” + ì •ì±… ì„¤ì •
  - SELECT: ëª¨ë“  ì‚¬ìš©ì
  - INSERT/UPDATE: Service roleë§Œ

## ğŸ’° ë¹„ìš© êµ¬ì¡°

### Supabase Free Tier
- 500MB Database âœ…
- Unlimited API requests âœ…
- 2GB Bandwidth/month âœ…
- Real-time ë¬´ì œí•œ âœ…

### ì˜ˆìƒ ì‚¬ìš©ëŸ‰ (1ê°œ ì§€ì )
- DB: ~10MB (55 seats Ã— 1ë…„ ì´ë²¤íŠ¸)
- API: ~100K req/month
- Bandwidth: ~500MB/month
- **ë¹„ìš©: $0/ì›”** ğŸ‰

### í™•ì¥ ì‹œ (3ê°œ ì§€ì )
- DB: ~30MB
- API: ~300K req/month
- **ì—¬ì „íˆ Free Tier ë²”ìœ„!**

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### 1ë‹¨ê³„: ì„œë²„ ì‹œì‘
```bash
# Terminal 1: Seats API
python -m src.api.seats_api

# Terminal 2: ROI Config API (ì„ íƒ)
python -m src.api.roi_config_api
```

### 2ë‹¨ê³„: Worker ì‹œì‘
```bash
# Terminal 3: Detection Worker
python -m src.workers.detection_worker --store oryudong --channels 1,2,3,4
```

### 3ë‹¨ê³„: ëª¨ë‹ˆí„°ë§
```bash
# Browser
http://localhost:8001/static/dashboard.html
```

## ğŸ“ˆ ì„±ëŠ¥

### ì²˜ë¦¬ ì†ë„
- YOLO Detection: ~30ms/frame (CPU)
- ROI Matching: ~5ms
- DB Update: ~20ms
- **Total: ~55ms/frame** â†’ ì´ˆë‹¹ 18í”„ë ˆì„ ê°€ëŠ¥

### ì‹¤ì œ ìš´ì˜
- Snapshot Interval: 3ì´ˆ (ì„¤ì • ê°€ëŠ¥)
- 16ì±„ë„ Ã— 4 workers = 64 í”„ë¡œì„¸ìŠ¤
- CPU ì‚¬ìš©ë¥ : ~40-60% (4 core)
- Memory: ~2GB

## ğŸ”§ ì£¼ìš” ì„¤ì •

### .env
```bash
YOLO_MODEL=yolo11n.pt              # ëª¨ë¸
CONFIDENCE_THRESHOLD=0.3           # ê°ì§€ ì‹ ë¢°ë„
IOU_THRESHOLD=0.3                  # ROI ë§¤ì¹­ ì„ê³„ê°’
SNAPSHOT_INTERVAL=3                # ìŠ¤ëƒ…ìƒ· ê°„ê²© (ì´ˆ)
ACTIVE_CHANNELS=1,2,3,4,5,...,16   # í™œì„± ì±„ë„
```

### Worker ì»¤ë§¨ë“œ
```bash
python -m src.workers.detection_worker \
  --store oryudong \                # ì§€ì  ID
  --channels 1,2,3,4                # ëª¨ë‹ˆí„°ë§í•  ì±„ë„
```

---

**êµ¬ì¡° ìš”ì•½**: Supabase (DB) â† FastAPI (API) â† Detection Workers (YOLO) â† NVR (RTSP) â† Cameras ğŸ“¹
