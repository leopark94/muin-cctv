# 앤딩스터디카페 CCTV 좌석 감지 시스템 기술 명세서

## 1. 프로젝트 개요

### 목표
- CCTV 영상을 통해 스터디카페 좌석 점유 상태 실시간 감지
- 앤딩 앱에 좌석 현황 데이터 제공

### 현황
- DVR: 이와트론 (Ewatron) HAR316
- RTSP 연결 성공: `rtsp://[user]:[pass]@218.50.241.157:8554/live`
- 지점 수: 40개 (파일럿 3~5개 예정)
- DVR당 카메라: 4~16ch (좌석 감지용은 일부 채널만)

---

## 2. 시스템 아키텍처

### 전체 흐름
```
DVR (RTSP) → 영상 수집 → ML 모델 → 좌석 상태 API → 앤딩 앱
```

### 상세 흐름
```
┌──────────┐     RTSP      ┌──────────┐    스냅샷     ┌──────────────┐
│   DVR    │──────────────▶│  영상    │─────────────▶│   ML 모델    │
│  (지점)   │   ch1~chN    │  수집    │   1~3초 간격  │  (YOLOv8)    │
└──────────┘               └──────────┘              └──────────────┘
                                                            │
                                                            ▼
┌──────────┐    푸시/폴링   ┌──────────┐   좌석 상태   ┌──────────────┐
│  앤딩    │◀──────────────│   API    │◀─────────────│   ROI 매칭    │
│   앱    │               │  서버    │   JSON       │   결과 처리   │
└──────────┘               └──────────┘              └──────────────┘
```

### 인프라 구성 (권장: 스냅샷 클라우드 방식)
```
지점1 DVR ──RTSP──┐
지점2 DVR ──RTSP──┼──▶ 클라우드 ML 서버 ──▶ API ──▶ 앱
지점N DVR ──RTSP──┘         (AWS)
```

---

## 3. 기술 스택

### ML 모델
- **권장**: YOLOv8n (nano) 또는 YOLOv11n
- **이유**: 
  - 사람 감지 pre-trained 모델 바로 사용 가능
  - 가볍고 빠름 (CPU로도 3초 간격 충분)
  - Ultralytics 생태계, 문서/예제 풍부
  - 파인튜닝 쉬움

### 필요 라이브러리
```
ultralytics      # YOLOv8/v11
opencv-python    # 영상 처리, RTSP 연결
numpy            # 배열 연산
pillow           # 이미지 처리
fastapi          # API 서버 (선택)
```

---

## 4. 좌석 감지 전략

### 4.1 ROI (Region of Interest) 기반 감지

카메라별로 좌석 영역을 사전 설정하고, YOLO 사람 감지 결과와 매칭

```
1. 설정 단계 (지점당 1회)
   - 관리자 웹 UI에서 CCTV 스냅샷 로드
   - 마우스로 좌석 영역 드래그하여 지정
   - 좌석 번호 입력 및 저장 → JSON

2. 런타임 (자동)
   RTSP 프레임 → YOLO(사람감지) → ROI 매칭 → 좌석 상태
```

### 4.2 ROI 설정 데이터 구조
```json
{
  "camera_id": "branch01_cam1",
  "resolution": [1920, 1080],
  "seats": [
    {"id": "9",  "roi": [120, 380, 220, 480], "label": "9번 좌석"},
    {"id": "10", "roi": [240, 380, 340, 480], "label": "10번 좌석"},
    {"id": "11", "roi": [360, 380, 460, 480], "label": "11번 좌석"},
    {"id": "14", "roi": [280, 180, 380, 280], "label": "14번 좌석"}
  ]
}
```

### 4.3 감지 로직
```python
def check_seat_occupancy(person_boxes, seat_rois, iou_threshold=0.3):
    """
    person_boxes: YOLO가 감지한 사람 바운딩박스 리스트 [(x1,y1,x2,y2), ...]
    seat_rois: 좌석 영역 리스트 [{"id": "9", "roi": [x1,y1,x2,y2]}, ...]
    
    Returns: {"9": "occupied", "10": "empty", ...}
    """
    results = {}
    for seat in seat_rois:
        seat_box = seat["roi"]
        occupied = False
        for person_box in person_boxes:
            if calculate_iou(person_box, seat_box) > iou_threshold:
                occupied = True
                break
        results[seat["id"]] = "occupied" if occupied else "empty"
    return results
```

---

## 5. 구현 태스크

### Phase 1: ROI 설정 도구 (관리자용)
- [ ] 웹 UI 개발 (React 또는 간단한 HTML/JS)
- [ ] RTSP 스냅샷 캡처 기능
- [ ] 이미지 위 드래그로 좌석 영역 그리기
- [ ] 좌석 ID 입력 및 JSON 저장/로드

### Phase 2: 감지 엔진
- [ ] RTSP 스트림 연결 및 프레임 추출
- [ ] YOLOv8 사람 감지 적용
- [ ] ROI 매칭 로직 구현
- [ ] 좌석 상태 JSON 출력

### Phase 3: API 서버
- [ ] FastAPI 기반 REST API
- [ ] 실시간 좌석 상태 조회 엔드포인트
- [ ] 지점/카메라별 상태 관리

### Phase 4: 최적화
- [ ] 변화 감지 (상태 바뀔 때만 업데이트)
- [ ] 심야 시간 간격 조정
- [ ] 멀티 카메라 병렬 처리

---

## 6. 예상 비용 (40개 지점 기준)

### 트래픽 계산
```
- 좌석 감지용 카메라: 지점당 6ch
- 영업시간: 14시간
- 스냅샷 간격: 3초
- 이미지 크기: 480p JPEG ≈ 30KB

분당: 20장 × 6채널 = 120장
하루: 120 × 60 × 14시간 = 100,800장
용량: 100,800 × 30KB ≈ 3GB/일/지점
40개 지점: 120GB/일 ≈ 3.6TB/월
```

### AWS 비용 (최적화 전)
| 항목 | 비용 |
|------|------|
| 데이터 전송 3.6TB | ~35만원 |
| EC2 GPU (g4dn.xlarge) | ~50만원 |
| S3 저장 (선택) | 5~10만원 |
| **총** | **~90-100만원/월** |

### 최적화 후: 30~50만원/월 가능
- 변화 감지로 트래픽 70% 절감
- 심야 간격 늘리기
- 스팟 인스턴스

---

## 7. RTSP 연결 정보

### URL 형식
```
rtsp://[username]:[password]@[IP]:[port]/[path]
```

### 채널별 URL (테스트 필요)
```
rtsp://admin:pw@IP:8554/ch1
rtsp://admin:pw@IP:8554/ch01
rtsp://admin:pw@IP:8554/live/ch1
rtsp://admin:pw@IP:8554/stream1
```

---

## 8. 참고 이미지

현장 CCTV 화면 예시:
- 위에서 내려다보는 앵글
- 좌석 번호 스티커 부착됨 (9, 10, 11, 12, 13, 14, 15...)
- 칸막이로 구분된 개인 좌석
- 사람 앉으면 상반신(머리+어깨+등) 보임

### 감지 포인트
- 사람의 머리+어깨+등 영역
- 칸막이 내부 의자 영역과 겹침 여부로 판단

---

## 9. 다음 단계

1. **YOLO 테스트**: 현장 이미지에 YOLOv8 돌려서 사람 감지 결과 확인
2. **ROI 설정 도구**: 간단한 웹 UI로 좌석 영역 그리는 도구 개발
3. **파일럿 테스트**: 1개 지점에서 end-to-end 테스트
4. **앱 연동**: 앤딩 앱 API 연결
